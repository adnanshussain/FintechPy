{% extends 'publicweb/layout.html' %}
{% block body %}
<div class="ui padded grid">
	<div class="one wide column">
		<span class="ui orange large header"><i class="idea icon"></i></span>
	</div>
	<div class="fifteen wide column">
		<span class="ui orange large header">How many times were</span>
		<select class="ui compact selection dropdown" id="stock_entity_type">
			<option value="1">Companies</option>
			<option value="2">Markets</option>
			<option value="5">Commodities</option>
		</select>
		<!-- This Spacer should be generated by Jinja ! -->
		<div style="width: .5em; display: inline-block"></div>
		<div class="ui radio checkbox">
			<input type="radio" name="direction" value="above" {% if direction == 'above' %} checked {% endif %}>
			<label>Above</label>
		</div>
		<div style="width: .5em; display: inline-block"></div>
		<div class="ui radio checkbox">
			<input type="radio" name="direction" value="below" {% if direction == 'below' %} checked {% endif %}>
			<label>Below</label>
		</div>
		<div style="width: .5em; display: inline-block"></div>
		<span class="ui orange large header"> by </span>
		<div class="ui right labeled input">
			<input type="text" style="width: 5em" value="{{ percent }}" id="percentage">
			<div class="ui basic label">%</div>
		</div>
		<span class="ui orange large header"> from </span>
		<select class="ui compact selection dropdown" id="from_yr">
			{% for yr in range(min_yr, max_yr + 1) %}
			<option value="{{ yr }}" {% if yr== from_yr %} selected="selected" {% endif %}>{{ yr }}</option>
			{% endfor %}
		</select>
		<span class="ui orange large header"> to </span>
		<select class="ui compact selection dropdown" id="to_yr">
			{% for yr in range(min_yr, max_yr + 1) %}
			<option value="{{ yr }}" {% if yr== to_yr %} selected="selected" {% endif %}>{{ yr }}</option>
			{% endfor %}
		</select>
		<div style="width: .5em; display: inline-block"></div>
		<button class="ui button" id="ask_question"> ?</button>
	</div>
</div>

<div class="ui centered grid">
	<div class="fifteen wide column">
		<div class="ui header" style="text-decoration: underline">Filters</div>
		<div class="ui grid">
			<div class="three wide column">
				<div class="ui one column grid">
					<div class="row">
						<div class="column">
							<div>Sectors:</div>
							<select class="ui search dropdown" id="=sector">
								{% for sector in all_sectors %}
								<option value="{{ sector.id }}">{{ sector.name_en }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="row">
						<div class="column">
							<button class="ui grey button" id="reverse_the_order">Reverse Order</button>
						</div>
					</div>
					<div class="row">
						<div class="column">
							<button class="ui grey button" id="rotate_chart">Rotate Chart</button>
						</div>
					</div>
				</div>
			</div>
			<div class="thirteen wide column">
				<div class="ui top attached tabular menu">
					<a class="item active" data-tab="visual">Visual</a>
					<a class="item" data-tab="textual">Textual</a>
				</div>
				<div class="ui bottom attached tab segment active" data-tab="visual">
					<div id="chartdiv" style="height: 500px; width: 100%"></div>
					<div id="curtain"><span>Chart is loading...</span></div>
				</div>
				<div class="ui bottom attached tab segment" data-tab="textual" id="text_result">
				</div>
			</div>
		</div>
	</div>
</div>
<div id="myToolTip" style="display: none;">
    <p><b>Help</b></p>
    <p>This will reverse the order of the graph from what is currently shown.<br/>
        Will toggle between Min and Max counts.
    </p>
    <p><a href="#">For a detailed example click here.</a></p>
</div>
{% endblock %}
{% block page_js %}
<script type="text/javascript">
	$(function() {
		$('.ui.dropdown').dropdown();
		$('.menu .item').tab();

		$("#reverse_the_order").data("powertiptarget", "myToolTip");
        $("#reverse_the_order").powerTip({
            placement: "e",
            mouseOnToPopup: true
        });

        makeChart({{ setid }}, '{{ direction }}', {{ percent }}, {{ from_yr }}, {{ to_yr }}, '{{ sort_order }}', {{ top_n }}, true);

        $('#ask_question').on('click', askQuestion);
	});

	function askQuestion() {
		setid = $('#stock_entity_type').val();
		direction = $('input[name=direction]:checked').val()
		percent = $('#percentage').val()
		from_yr = $('#from_yr').val()
		to_yr = $('#to_yr').val()

		drawChart(setid, direction, percent, from_yr, to_yr, 'desc', 10, true, true);
	}

	var chart;

	function drawChart(setid, direction, percent, from_yr, to_yr, sort_order, top_n, rotate_chart, redraw = false) {
		$.ajax('{{ url_for('api.q1_aggregate') }}' + '/' + setid + '/' + direction + '/' + percent + '/' + from_yr + '/' + to_yr
						+ '/' + sort_order + '/' + top_n, {
        	cache: false,
        	success: function (data, status, xhrObj) {
            	console.log("ajax success, data received.", data);

				data_1 = data.slice(0, data.length - 1)

            	chart.dataProvider = data_1;
				chart.titles = [{
					"text": "Number of times " + $('#stock_entity_type option:selected').text()
							+ " where " + direction + " " + percent + "% from " + from_yr + " to " + to_yr
				}];
				chart.valueAxes[0].guides[0].value = data[data.length - 1];

				if(redraw) {
            		chart.validateData()
            	}
            	else {
					// WRITE
					chart.write("chartdiv");
				}
        	},
        	error: function (xhrObj, status, errorThrown) {
            	console.log(errorThrown);
        	}
    	});
	}

	function makeChart(setid, direction, percent, from_yr, to_yr, sort_order, top_n, rotate_chart) {
		AmCharts.ready(function () {
			// SERIAL CHART
			chart = new AmCharts.AmSerialChart();
			/*
			chart.dataLoader = {
				"url": "{{ url_for('api.q1_aggregate') }}" + '/' + setid + '/' + direction + '/' + percent + '/' + from_yr + '/' + to_yr
						+ '/' + sort_order + '/' + top_n,
				"format": "json"
			};
			*/
			chart.categoryField = "short_name_en";
			chart.startDuration = 1;
			chart.plotAreaBorderColor = "#DADADA";
			chart.plotAreaBorderAlpha = 1;
			chart.addClassNames = true;
			chart.titles = [{
				"text": "Number of times " + $('#stock_entity_type option:selected').text()
						+ " where {% if percent >= 0 %} above {% else %} below {% endif %} {{ percent }}% from 1993 to 2016"
			}],
			// this single line makes the chart a bar chart
			chart.rotate = true;
			chart.addListener("rendered", function(e) {
      			var curtain = document.getElementById("curtain");
      			curtain.parentElement.removeChild(curtain);
    		});

			// AXES
			// Category
			var categoryAxis = chart.categoryAxis;
			categoryAxis.gridPosition = "start";
			categoryAxis.gridAlpha = 0.1;
			categoryAxis.axisAlpha = 0;
			categoryAxis.title = "Companies";
			//categoryAxis.classNameField = "catAxisLabelCSS";
			/*categoryAxis.addListener("clickItem", function (event) {
			 window.location = "q1_individual_entity.html";
			 });*/

			// Value
			var valueAxis = new AmCharts.ValueAxis();
			valueAxis.axisAlpha = 0;
			valueAxis.gridAlpha = 0.1;
			valueAxis.title = "Count";
			valueAxis.labelFunction = function (value, valueText, valueAxis) {
				return (value);
			};
			valueAxis.guides = [{
				value: 50,
				lineColor: "#CC0000",
				lineAlpha: 1,
				lineThickness: 1.5,
				dashLength: 5,
				inside: true,
				labelRotation: 90,
				label: "Average",
				boldLabel: true,
				//inside: false,
				position: "bottom",
				above: true,
				"balloonText": "<span style='font-size:14px; color:#000000;'><b>Average</b></span>",
			}];
			//valueAxis.position = "top";
			chart.addValueAxis(valueAxis);

			// GRAPHS
			// first graph
			var graph1 = new AmCharts.AmGraph();
			graph1.type = "column";
			graph1.title = "Count";
			graph1.valueField = "frequency";
			graph1.balloonText = "Count:[[value]]<br/>Click to Drilldown";
			graph1.lineAlpha = 0;
			//graph1.fillColors = "#ADD981";
			graph1.fillAlphas = 1;
			graph1.classNameField = "catAxisLabelCSS";
			graph1.addListener("clickGraphItem", function (event) {
				window.location = "q1_individual_entity.html";
			});
			chart.addGraph(graph1);

			// LEGEND
			/*var legend = new AmCharts.AmLegend();
			 chart.addLegend(legend);*/

			chart.creditsPosition = "top-right";

			drawChart(setid, direction, percent, from_yr, to_yr, 'desc', 10, true, false);
		});
	}
</script>
{% endblock %}