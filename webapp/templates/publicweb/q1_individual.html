{% import 'publicweb/partials/macros.html' as macros %}
{% extends 'publicweb/layout.html' %}
{% block body %}
<div class="ui padded grid">
	<div class="one wide column">
		<span class="ui orange large header"><i class="idea icon"></i></span>
	</div>
	<div class="fifteen wide column">
		<span class="ui orange large header">How many times was</span>
		{{ macros.spacer() }}
		{{ macros.select_by_dict_list("stock_entity", all_companies, selected_company.id, 'compact', True) }}
		<!-- This Spacer should be generated by Jinja ! -->
		<div style="width: .5em; display: inline-block"></div>
		<div class="ui radio checkbox">
			<input type="radio" name="direction" value="above" {% if direction== 'above' %} checked {% endif %}>
			<label>Above</label>
		</div>
		<div style="width: .5em; display: inline-block"></div>
		<div class="ui radio checkbox">
			<input type="radio" name="direction" value="below" {% if direction== 'below' %} checked {% endif %}>
			<label>Below</label>
		</div>
		<div style="width: .5em; display: inline-block"></div>
		<span class="ui orange large header"> by </span>
		<div class="ui right labeled input">
			<input type="text" style="width: 5em" value="{{ percent }}" id="percentage">
			<div class="ui basic label">%</div>
		</div>
		<span class="ui orange large header"> from </span>
		<select class="ui compact selection dropdown" id="from_yr">
			{% for yr in range(min_yr, max_yr + 1) %}
			<option value="{{ yr }}" {% if yr== from_yr %} selected="selected" {% endif %}>{{ yr }}</option>
			{% endfor %}
		</select>
		<span class="ui orange large header"> to </span>
		<select class="ui compact selection dropdown" id="to_yr">
			{% for yr in range(min_yr, max_yr + 1) %}
			<option value="{{ yr }}" {% if yr== to_yr %} selected="selected" {% endif %}>{{ yr }}</option>
			{% endfor %}
		</select>
		<div style="width: .5em; display: inline-block"></div>
		<button class="ui button" id="ask_question"> ?</button>
	</div>
</div>

<!--USE A GRID INSIDE A GRID FOR FINE TUNING-->
<div class="ui centered grid">
	<div class="fifteen wide column">
		<div class="ui grid">
			<div class="four wide column">
				<div class="ui big orange label" id="selected_company_name">{{ selected_company.name_en }}</div>
			</div>
			<div class="eleven wide right aligned column">
				<div class="ui header" style="display: inline-block;">Compare To:</div>
				<select class="ui search dropdown">
				</select>
				<a class="ui button" href="q1_individual_entities_compared.html">Go</a>
			</div>
			<div class="sixteen wide column">
				<div class="ui top attached tabular menu">
					<a class="item active" data-tab="visual">Visual</a>
					<a class="item" data-tab="textual">Textual</a>
				</div>
				<div class="ui bottom attached tab segment active" data-tab="visual">
					<div id="chartdiv" style="height: 400px; width: 100%"></div>
					<div id="curtain"><span>Chart is loading...</span></div>
				</div>
				<div class="ui bottom attached tab segment" data-tab="textual">
					Second
				</div>
			</div>
		</div>
	</div>
</div>
{% endblock %}
{% block page_js %}
<script type="text/javascript">
	$(function() {
		$('.ui.dropdown').dropdown();
		$('.menu .item').tab();

        $('#ask_question').on('click', askQuestion);

        buildChart();

		p = getQuestionParameters();

        drawChart(1, p.seid, p.direction, p.percent, p.from_yr, p.to_yr);
	});

	function getQuestionParameters() {
		return({
			seid: $('#stock_entity').val(),
			direction: $('input[name=direction]:checked').val(),
			percent: $('#percentage').val(),
			from_yr: $('#from_yr').val(),
			to_yr: $('#to_yr').val()
		});
	}

	function askQuestion() {
		p = getQuestionParameters();

		drawChart(1, p.seid, p.direction, p.percent, p.from_yr, p.to_yr, true, true);
	}

	var chart;

	function drawChart(setid, seid, direction, percent, from_yr, to_yr,rotate_chart = false, redraw = false) {
		loadWithAjax('{{ url_for('api.q1_individual') }}' + '/' + setid + '/' + seid + '/' + direction + '/' + percent + '/' + from_yr + '/' + to_yr,
			// Success Handler
			function(data) {
            	chart.dataProvider = data.main_data;
				chart.titles = [{
					"text": "Number of times " 
							//+ $('#stock_entity option:selected').text().trim() 
							+ data.name_ar
							+ " was " + direction + " " + percent + "% from " + from_yr + " to " + to_yr
				}];
				chart.valueAxes[0].guides[0].value = data[data.length - 1];

				$('#selected_company_name').html(data.name_en);

				if(redraw) {
            		chart.validateData()
            	}
            	else {
					// WRITE
					chart.write("chartdiv");
				}
			});
	}

	function buildChart() {
		chart = new AmCharts.AmSerialChart();
		buildAmBarChart(chart, "year", "frequency", function(e) {
        	console.log("Bar clicked, do wacchu like !");
        });
	}
</script>
{% endblock %}